/*
 * File:   mainADC.c
 * Author: dmore
 *
 * Created on 25 de mayo de 2024, 20:47
 */


#include "xc.h"
#include "CONFIG.h"
#include "ADCLIB.h"
#include "stdint.h"
#include "stdio.h"
#include "I2C.h"
#include <libpic30.h>
uint16_t valor_adc=0;
uint16_t valor_adc1[15];
uint16_t data[30];
uint16_t datafilt[30];
//coeff es un filtro highpass
float coeff[]={                               
-0.011095048197348507043602516830560489325,
 0.008663714780986665406348201656783203362,
-0.01170293630124587778984501795775940991,
 0.015153830392082543593312848884124832693,
-0.018957305676202657052087374722759705037,
 0.023031463241195399005434296668681781739,
-0.027271370885714459747495297392561042216,
 0.031563866842783873389866045044982456602,
-0.035784328388975113199865774049612809904,
 0.039797706290037301868345309685537358746,
-0.043468311089067443453437533662508940324,
 0.046669715297620296967640030061375000514,
-0.049289838689163222029687716485568671487,
 0.051234244500733661098479387874249368906,
-0.052430860772282705806190961084212176502,
 0.052834786282770988818935364861317793839,
-0.052430860772282705806190961084212176502,
 0.051234244500733661098479387874249368906,
-0.049289838689163222029687716485568671487,
 0.046669715297620296967640030061375000514,
-0.043468311089067443453437533662508940324,
 0.039797706290037301868345309685537358746,
-0.035784328388975113199865774049612809904,
 0.031563866842783873389866045044982456602,
-0.027271370885714459747495297392561042216,
 0.023031463241195399005434296668681781739,
-0.018957305676202657052087374722759705037,
 0.015153830392082543593312848884124832693,
-0.01170293630124587778984501795775940991, 
 0.008663714780986665406348201656783203362,
-0.011095048197348507043602516830560489325,
};
//coeff2 es un filtro lowpass
float coeff2[]={0.107376959579705458236453807785437675193,
-0.0152552719296910627849728214755486988,
 0.016191793150795493611004971512556949165,
-0.017082683634339443368155286862020147964,
 0.017954769214383024117376308481652813498,
-0.018822756760320087654481113759175059386,
 0.019649157472886851633075977474618412089,
-0.020381878840441722267051716244168346748,
 0.020929723567933065930812830401919200085,
-0.021582054716079199230271967735461657867,
 0.022033014329478167042664082941882952582,
-0.022447777046899160258153216318532940932,
 0.022768032515557909412073911425977712497,
-0.022965611201334772129012407049231114797,
 0.023096550169260095936030197094623872545,
 0.976881230192162774983444251120090484619,
 0.023096550169260095936030197094623872545,
-0.022965611201334772129012407049231114797,
 0.022768032515557909412073911425977712497,
-0.022447777046899160258153216318532940932,
 0.022033014329478167042664082941882952582,
-0.021582054716079199230271967735461657867,
 0.020929723567933065930812830401919200085,
-0.020381878840441722267051716244168346748,
 0.019649157472886851633075977474618412089,
-0.018822756760320087654481113759175059386,
 0.017954769214383024117376308481652813498,
-0.017082683634339443368155286862020147964,
 0.016191793150795493611004971512556949165,
-0.0152552719296910627849728214755486988,  
 0.107376959579705458236453807785437675193};
float voltaje=0;
float voltaje11=0;
int i=0;
int bufsize=30;
int main(void) {
    ADC_INIT();
    I2C_INIT();
    while(1){
        
        AD1CON1bits.SAMP=1;
        __delay_ms(100);
        AD1CON1bits.SAMP=0;
        while(!AD1CON1bits.DONE);
        //valor_adc=ADCBUF0;
       valor_adc=ADC1BUF0;
       
       
        voltaje=valor_adc*(3.3/65520);
        //data[i]=voltaje;
        data[i]=valor_adc;
        i=i+1;
        if(i>=30){
             
             for(int n=0;n<30;n++){
                 datafilt[n]=0;
                 for(int k=0;k<30;k++){
                     datafilt[n]+=coeff[k]*data[bufsize-k];
             
                    }  
             }
             for(int p=0;p<30;p++){
            I2C_START();
            I2C_TX(0b11000000);
            I2C_TX(0b01000000);
            I2C_TX((uint8_t)(datafilt[p] >> 4));
            I2C_TX((uint8_t)((datafilt[p] & 0b1111)<<4));
            I2C_STOP();
            }
            i=0;
        }
        voltaje11=data[i];
        /*
        for(int i=0;i<16;i++){
            I2C_START();
            I2C_TX(0b11000000);
            I2C_TX(0b01000000);
            I2C_TX((uint8_t)(valor_adc >> 4));
            I2C_TX((uint8_t)((valor_adc & 0b1111)<<4));
            I2C_STOP();
        
        }
    */
    
    }
    return 0;
}
